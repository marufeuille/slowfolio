{{/* Renders an album story from data: expects dict { key: "trip-2024" } */}}
{{ $ctx := . }}
{{ $key := $ctx.key }}
{{ if and $key (index .Site.Data.stories $key) }}
  {{ $data := index .Site.Data.stories $key }}
  {{ with $data.title }}<h1 class="title">{{ . }}</h1>{{ end }}
  {{ with $data.summary }}<p class="subtitle">{{ . }}</p>{{ end }}

  {{ range $ch := $data.chapters }}
    <section class="content" id="{{ with $ch.slug }}{{ . }}{{ end }}">
      {{ with $ch.title }}<h2>{{ . }}</h2>{{ end }}
      {{ $gateHash := $ch.gateHash }}
      {{ $gateHint := $ch.gateHint }}
      {{ if $gateHash }}
        <div class="gate" data-gate-hash="{{ $gateHash }}">
          <div class="gate__form">
            <p>この章はパスワードで保護されています。</p>
            <form>
              <input type="password" placeholder="パスワード" aria-label="パスワード" />
              <button type="submit">開く</button>
              {{ with $gateHint }}<div class="gate__hint">ヒント: {{ . }}</div>{{ end }}
              <div data-invalid style="color:#b00020;margin-top:6px"></div>
              <noscript>JavaScriptを有効にしてください。</noscript>
            </form>
          </div>
          <div class="gate__content">
      {{ end }}

      {{ range $block := $ch.blocks }}
        {{ $type := $block.type }}
        {{ if eq $type "text" }}
          <div class="prose">{{ $block.content | markdownify }}</div>
        {{ else if eq $type "photo" }}
          <figure class="photo photo--{{ $block.width | default "full" }}">
            <img src="{{ $block.src }}" alt="{{ $block.alt }}" loading="lazy" />
            {{ with $block.caption }}<figcaption>{{ . }}</figcaption>{{ end }}
          </figure>
        {{ else if eq $type "grid" }}
          <div class="grid cols-{{ $block.cols | default 3 }}">
            {{ range $img := $block.photos }}
              <figure class="photo">
                <img src="{{ $img.src }}" alt="{{ $img.alt }}" loading="lazy" />
                {{ with $img.caption }}<figcaption>{{ . }}</figcaption>{{ end }}
              </figure>
            {{ end }}
          </div>
        {{ else if eq $type "mosaic" }}
          <div class="mosaic">
            {{ range $tile := $block.tiles }}
              {{ $parts := split ($tile.span | default "1x1") "x" }}
              {{ $col := index $parts 0 }}
              {{ $row := index $parts 1 }}
              <div class="mosaic__tile" style="grid-column: span {{ $col }}; grid-row: span {{ $row }};">
                <img src="{{ $tile.src }}" alt="{{ $tile.alt }}" loading="lazy"/>
              </div>
            {{ end }}
          </div>
        {{ else if eq $type "spread" }}
          <section class="spread{{ if eq ($block.side | default "left") "right" }} spread--right{{ end }}">
            <div class="spread__image">
              <img src="{{ $block.image }}" alt="{{ $block.alt }}" loading="lazy"/>
              {{ with $block.caption }}<div class="spread__caption">{{ . }}</div>{{ end }}
            </div>
            <div class="spread__text">{{ $block.text | markdownify }}</div>
          </section>
        {{ else if eq $type "spacer" }}
          <div class="spacer spacer-{{ $block.size | default 24 }}" aria-hidden="true"></div>
        {{ end }}
      {{ end }}

      {{ if $gateHash }}
          </div>
        </div>
      {{ end }}
    </section>
  {{ end }}
{{ else }}
  <p>ストーリーデータ（key: {{ $key }}) が見つかりません。</p>
{{ end }}

